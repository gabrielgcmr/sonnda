<!-- internal/adapters/inbound/http/web/templates/pages/register.html -->
{{define "pages/register"}}
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastro - Sonnda</title>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <link rel="stylesheet" href="/assets/static/tailwind.css" />
  <script src="/assets/static/firebase-auth.js"></script>
</head>
<body class="bg-gray-50">
  <main class="container mx-auto max-w-6xl px-4 py-8">
<div class="min-h-screen flex items-center justify-center px-4 py-8 bg-gray-50">
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 w-full max-w-sm">
    <div class="text-center mb-8">
      <h1 class="text-2xl font-bold text-gray-900 mb-2">Criar conta</h1>
      <p class="text-sm text-gray-600">Preencha seus dados para começar</p>
    </div>

    <!-- Alert messages -->
    <div id="alert-container"></div>

    <!-- Step indicator -->
    <div id="step-indicator" class="text-center mb-4">
      <small class="text-gray-600">Passo <span id="current-step">1</span> de 2</small>
    </div>

    <!-- Step 1: Firebase Authentication -->
    <form id="authForm" class="space-y-4">
      <div>
        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">E-mail</label>
        <input 
          type="email" 
          id="email" 
          name="email" 
          class="block w-full px-3.5 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-colors" 
          placeholder="seu@email.com"
          required
          autocomplete="email"
        />
        <span class="text-xs text-red-600 mt-1" id="email-error"></span>
      </div>

      <div>
        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
        <input 
          type="password" 
          id="password" 
          name="password" 
          class="block w-full px-3.5 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-colors" 
          placeholder="Mínimo 6 caracteres"
          required
          minlength="6"
          autocomplete="new-password"
        />
        <span class="text-xs text-red-600 mt-1" id="password-error"></span>
      </div>

      <div>
        <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">Confirmar Senha</label>
        <input 
          type="password" 
          id="confirmPassword" 
          name="confirmPassword" 
          class="block w-full px-3.5 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-colors" 
          placeholder="Digite a senha novamente"
          required
          minlength="6"
          autocomplete="new-password"
        />
        <span class="text-xs text-red-600 mt-1" id="confirmPassword-error"></span>
      </div>

      <button type="submit" class="w-full inline-flex items-center justify-center px-5 py-2.5 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" id="authButton">
        Continuar
      </button>
    </form>

    <!-- Step 2: Registration Data -->
    <form id="registerForm" class="space-y-4 hidden">
      <div>
        <label for="fullName" class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
        <input 
          type="text" 
          id="fullName" 
          name="fullName" 
          class="block w-full px-3.5 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-colors" 
          placeholder="Seu nome completo"
          required
        />
        <span class="text-xs text-red-600 mt-1" id="fullName-error"></span>
      </div>

      <div>
        <label for="birthDate" class="block text-sm font-medium text-gray-700 mb-2">Data de Nascimento</label>
        <input 
          type="date" 
          id="birthDate" 
          name="birthDate" 
          class="block w-full px-3.5 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-colors" 
          required
        />
        <span class="text-xs text-red-600 mt-1" id="birthDate-error"></span>
      </div>

      <div>
        <label for="cpf" class="block text-sm font-medium text-gray-700 mb-2">CPF</label>
        <input 
          type="text" 
          id="cpf" 
          name="cpf" 
          class="block w-full px-3.5 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-colors" 
          placeholder="000.000.000-00"
          required
          maxlength="14"
        />
        <span class="text-xs text-red-600 mt-1" id="cpf-error"></span>
      </div>

      <div>
        <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
        <input 
          type="tel" 
          id="phone" 
          name="phone" 
          class="block w-full px-3.5 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-colors" 
          placeholder="(00) 00000-0000"
          required
          maxlength="15"
        />
        <span class="text-xs text-red-600 mt-1" id="phone-error"></span>
      </div>

      <div>
        <label for="accountType" class="block text-sm font-medium text-gray-700 mb-2">Tipo de Conta</label>
        <select id="accountType" name="accountType" class="block w-full px-3.5 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-colors bg-white cursor-pointer" required>
          <option value="">Selecione...</option>
          <option value="basic_care">Cuidados Básicos</option>
          <option value="professional">Profissional de Saúde</option>
        </select>
        <span class="text-xs text-red-600 mt-1" id="accountType-error"></span>
      </div>

      <!-- Professional fields (conditional) -->
      <div id="professionalFields" class="hidden space-y-4">
        <div>
          <label for="professionalKind" class="block text-sm font-medium text-gray-700 mb-2">Tipo de Profissional</label>
          <select id="professionalKind" name="professionalKind" class="block w-full px-3.5 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-colors bg-white cursor-pointer">
            <option value="">Selecione...</option>
            <option value="physician">Médico</option>
            <option value="nurse">Enfermeiro</option>
            <option value="psychologist">Psicólogo</option>
            <option value="nutritionist">Nutricionista</option>
            <option value="physical_therapist">Fisioterapeuta</option>
            <option value="other">Outro</option>
          </select>
          <span class="text-xs text-red-600 mt-1" id="professionalKind-error"></span>
        </div>

        <div>
          <label for="registrationNumber" class="block text-sm font-medium text-gray-700 mb-2">Número de Registro</label>
          <input 
            type="text" 
            id="registrationNumber" 
            name="registrationNumber" 
            class="block w-full px-3.5 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-colors" 
            placeholder="Ex: CRM 12345"
          />
          <span class="text-xs text-red-600 mt-1" id="registrationNumber-error"></span>
        </div>

        <div>
          <label for="registrationIssuer" class="block text-sm font-medium text-gray-700 mb-2">Órgão Emissor</label>
          <input 
            type="text" 
            id="registrationIssuer" 
            name="registrationIssuer" 
            class="block w-full px-3.5 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-colors" 
            placeholder="Ex: CRM"
          />
          <span class="text-xs text-red-600 mt-1" id="registrationIssuer-error"></span>
        </div>

        <div>
          <label for="registrationState" class="block text-sm font-medium text-gray-700 mb-2">UF (opcional)</label>
          <input 
            type="text" 
            id="registrationState" 
            name="registrationState" 
            class="block w-full px-3.5 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-colors" 
            placeholder="Ex: SP"
            maxlength="2"
          />
          <span class="text-xs text-red-600 mt-1" id="registrationState-error"></span>
        </div>
      </div>

      <div class="flex gap-2">
        <button type="button" class="flex-1 inline-flex items-center justify-center px-5 py-2.5 text-sm font-medium text-blue-600 bg-white border border-gray-200 hover:bg-gray-50 rounded-lg transition-colors" id="backButton">
          Voltar
        </button>
        <button type="submit" class="flex-1 inline-flex items-center justify-center px-5 py-2.5 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" id="registerButton">
          Criar Conta
        </button>
      </div>
    </form>

    <div class="text-center mt-6 text-sm text-gray-600">
      Já tem uma conta? <a href="/login" class="text-blue-600 font-medium hover:underline">Entrar</a>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<!-- Firebase Auth Manager -->
<script src="/assets/firebase-auth.js"></script>

<script>
  const authForm = document.getElementById('authForm');
  const registerForm = document.getElementById('registerForm');
  const authButton = document.getElementById('authButton');
  const registerButton = document.getElementById('registerButton');
  const backButton = document.getElementById('backButton');
  const alertContainer = document.getElementById('alert-container');
  const accountTypeSelect = document.getElementById('accountType');
  const professionalFields = document.getElementById('professionalFields');

  function showAlert(message, type = 'info') {
    const alertClass = type === 'error' ? 'bg-red-50 text-red-800 border border-red-200' : 
                       type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' : 
                       'bg-blue-50 text-blue-800 border border-blue-200';
    alertContainer.innerHTML = `<div class="px-4 py-3 rounded-lg text-sm font-medium mb-4 ${alertClass}">${message}</div>`;
    alertContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  function clearErrors() {
    document.querySelectorAll('[id$="-error"]').forEach(el => el.textContent = '');
  }

  function showStep(stepNumber) {
    if (stepNumber === 1) {
      authForm.classList.remove('hidden');
      registerForm.classList.add('hidden');
      document.getElementById('current-step').textContent = '1';
    } else if (stepNumber === 2) {
      authForm.classList.add('hidden');
      registerForm.classList.remove('hidden');
      document.getElementById('current-step').textContent = '2';
    }
  }

  // Toggle professional fields based on account type
  accountTypeSelect.addEventListener('change', (e) => {
    if (e.target.value === 'professional') {
      professionalFields.classList.remove('hidden');
      document.getElementById('professionalKind').required = true;
      document.getElementById('registrationNumber').required = true;
      document.getElementById('registrationIssuer').required = true;
    } else {
      professionalFields.classList.add('hidden');
      document.getElementById('professionalKind').required = false;
      document.getElementById('registrationNumber').required = false;
      document.getElementById('registrationIssuer').required = false;
    }
  });

  // Step 1: Firebase Authentication
  authForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearErrors();
    
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    // Validation
    if (!email) {
      document.getElementById('email-error').textContent = 'E-mail é obrigatório';
      return;
    }

    if (password.length < 6) {
      document.getElementById('password-error').textContent = 'Senha deve ter pelo menos 6 caracteres';
      return;
    }

    if (password !== confirmPassword) {
      document.getElementById('confirmPassword-error').textContent = 'Senhas não conferem';
      return;
    }

    authButton.disabled = true;
    authButton.innerHTML = '<span class="inline-block animate-spin mr-2">⏳</span>Processando...';

    try {
      await firebaseAuth.signUp(email, password);
      showAlert('Autenticação bem-sucedida! Complete seu perfil.', 'success');
      showStep(2);
    } catch (error) {
      console.error('Firebase sign up error:', error);
      
      let errorMessage = 'Erro ao criar conta';
      if (error.code === 'auth/email-already-in-use') {
        errorMessage = 'Este e-mail já está cadastrado';
      } else if (error.code === 'auth/invalid-email') {
        errorMessage = 'E-mail inválido';
      } else if (error.code === 'auth/weak-password') {
        errorMessage = 'Senha fraca';
      }
      
      showAlert(errorMessage, 'error');
    } finally {
      authButton.disabled = false;
      authButton.textContent = 'Continuar';
    }
  });

  // Step 2: Registration Data
  registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearErrors();

    const fullName = document.getElementById('fullName').value.trim();
    const birthDate = document.getElementById('birthDate').value;
    const cpf = document.getElementById('cpf').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const accountType = document.getElementById('accountType').value;

    // Validation
    if (!fullName) {
      document.getElementById('fullName-error').textContent = 'Nome é obrigatório';
      return;
    }

    if (!birthDate) {
      document.getElementById('birthDate-error').textContent = 'Data de nascimento é obrigatória';
      return;
    }

    if (!cpf) {
      document.getElementById('cpf-error').textContent = 'CPF é obrigatório';
      return;
    }

    if (!phone) {
      document.getElementById('phone-error').textContent = 'Telefone é obrigatório';
      return;
    }

    if (!accountType) {
      document.getElementById('accountType-error').textContent = 'Tipo de conta é obrigatório';
      return;
    }

    let professionalData = {};
    if (accountType === 'professional') {
      const professionalKind = document.getElementById('professionalKind').value;
      const registrationNumber = document.getElementById('registrationNumber').value.trim();
      const registrationIssuer = document.getElementById('registrationIssuer').value.trim();
      const registrationState = document.getElementById('registrationState').value.trim();

      if (!professionalKind) {
        document.getElementById('professionalKind-error').textContent = 'Tipo de profissional é obrigatório';
        return;
      }

      if (!registrationNumber) {
        document.getElementById('registrationNumber-error').textContent = 'Número de registro é obrigatório';
        return;
      }

      if (!registrationIssuer) {
        document.getElementById('registrationIssuer-error').textContent = 'Órgão emissor é obrigatório';
        return;
      }

      professionalData = {
        kind: professionalKind,
        registration_number: registrationNumber,
        registration_issuer: registrationIssuer,
        registration_state: registrationState || null
      };
    }

    registerButton.disabled = true;
    registerButton.innerHTML = '<span class="inline-block animate-spin mr-2">⏳</span>Criando conta...';

    try {
      const idToken = await firebaseAuth.getIdToken();
      
      const payload = {
        email: document.getElementById('email').value,
        full_name: fullName,
        birth_date: birthDate,
        cpf: cpf,
        phone: phone,
        account_type: accountType,
        professional: accountType === 'professional' ? professionalData : null
      };

      const response = await fetch('/api/registration/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${idToken}`
        },
        body: JSON.stringify(payload)
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message || 'Erro ao registrar usuário');
      }

      showAlert('Conta criada com sucesso! Redirecionando...', 'success');
      setTimeout(() => {
        window.location.href = '/dashboard';
      }, 2000);
    } catch (error) {
      console.error('Registration error:', error);
      showAlert(error.message || 'Erro ao registrar', 'error');
    } finally {
      registerButton.disabled = false;
      registerButton.innerHTML = 'Criar Conta';
    }
  });

  backButton.addEventListener('click', () => {
    clearErrors();
    showStep(1);
  });

  // Initialize Firebase when page loads
  document.addEventListener('DOMContentLoaded', () => {
    if (typeof window.firebaseAuth === 'undefined') {
      firebaseAuth.initialize(window.FIREBASE_CONFIG || {});
    }
  });
</script>
  </main>
</body>
</html>
{{end}}
