# internal/api/openapi/openapi.yaml
# NOTE: source of truth. Embedded and served at /openapi.yaml.
openapi: 3.0.3
info:
  title: Sonnda API
  version: "0.1.0"
  description: |-
    OpenAPI inicial das rotas HTTP da Sonnda.

    Nota (MVP): criação/gestão de profissionais ainda não está implementada.
servers:
  - url: http://localhost:8080
    description: Desenvolvimento local
  - url: https://api.sonnda.com.br
    description: Produção
security:
  - bearerAuth: []
paths:
  # =========================
  # Public
  # =========================
  /:
    get:
      summary: API metadata
      security: []
      tags: [Public]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RootResponse"

  /healthz:
    get:
      summary: Health check
      security: []
      tags: [Public]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
  /readyz:
    get:
      summary: Readiness check
      security: []
      tags: [Public]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
  /docs:
    get:
      summary: API docs (Redoc)
      security: []
      tags: [Public]
      responses:
        "200":
          description: HTML
          content:
            text/html:
              schema:
                type: string
  # =========================
  # User
  # =========================
  /v1/users:
    post:
      summary: Criar usuário
      description: |-
        Cria o usuário da plataforma a partir da identidade autenticada (JWT do Supabase).
        Requer token válido do Supabase (Bearer).

        Nota (MVP): `account_type=professional` ainda não está implementado.
      tags: [User]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateUserRequest"
      responses:
        "201":
          description: Usuário criado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "409":
          $ref: "#/components/responses/AppError"
        "400":
          $ref: "#/components/responses/AppError"
        "401":
          $ref: "#/components/responses/AppError"
        "422":
          $ref: "#/components/responses/AppError"
        "500":
          $ref: "#/components/responses/AppError"
  /v1/me:
    get:
      summary: Obter perfil do usuário atual
      tags: [User]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          $ref: "#/components/responses/AppError"
        "500":
          $ref: "#/components/responses/AppError"
    put:
      summary: Atualizar perfil do usuário atual
      tags: [User]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateUserRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          $ref: "#/components/responses/AppError"
        "401":
          $ref: "#/components/responses/AppError"
        "422":
          $ref: "#/components/responses/AppError"
        "500":
          $ref: "#/components/responses/AppError"
    delete:
      summary: Remover usuário atual (hard delete)
      tags: [User]
      responses:
        "204":
          description: No Content
        "401":
          $ref: "#/components/responses/AppError"
        "500":
          $ref: "#/components/responses/AppError"
  /v1/me/patients:
    get:
      summary: Listar pacientes do usuário atual
      tags: [User]
      parameters:
        - $ref: "#/components/parameters/LimitParam"
        - $ref: "#/components/parameters/OffsetParam"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PatientsList"
        "401":
          $ref: "#/components/responses/AppError"
        "500":
          $ref: "#/components/responses/AppError"

  # =========================
  # patients
  # =========================
  /v1/patients:
    post:
      summary: Criar paciente
      tags: [Patient]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePatientRequest"
      responses:
        "201":
          description: Paciente criado
          headers:
            Location:
              description: Caminho do novo recurso
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PatientCreatedResponse"
        "400":
          $ref: "#/components/responses/AppError"
        "401":
          $ref: "#/components/responses/AppError"
        "422":
          $ref: "#/components/responses/AppError"
        "500":
          $ref: "#/components/responses/AppError"
    get:
      summary: Listar pacientes
      tags: [Patient]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PatientsList"
        "401":
          $ref: "#/components/responses/AppError"
        "500":
          $ref: "#/components/responses/AppError"
  /v1/patients/{id}:
    get:
      summary: Obter paciente
      tags: [Patient]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Patient"
        "400":
          $ref: "#/components/responses/AppError"
        "401":
          $ref: "#/components/responses/AppError"
        "404":
          $ref: "#/components/responses/AppError"
        "500":
          $ref: "#/components/responses/AppError"
  /v1/patients/{id}/labs:
    get:
      summary: Listar laudos
      tags:
        - Labs
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: expand
          in: query
          required: false
          schema:
            type: string
            enum:
              - full
          description: Retorna a representação completa quando expand=full
        - name: include
          in: query
          required: false
          schema:
            type: string
          description: "Lista de campos para expandir (ex.: results)"
        - $ref: "#/components/parameters/LimitParam"
        - $ref: "#/components/parameters/OffsetParam"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LabsList"
        "400":
          $ref: "#/components/responses/AppError"
        "401":
          $ref: "#/components/responses/AppError"
        "500":
          $ref: "#/components/responses/AppError"
    post:
      summary: Upload de laudo
      tags: [Labs]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
      responses:
        "201":
          description: Laudo criado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LabUploadResponse"
        "400":
          $ref: "#/components/responses/AppError"
        "401":
          $ref: "#/components/responses/AppError"
        "413":
          $ref: "#/components/responses/AppError"
        "415":
          $ref: "#/components/responses/AppError"
        "500":
          $ref: "#/components/responses/AppError"
# =========================
# Components
# =========================
components:
  # =========================
  # Security Schemes
  # =========================
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    LimitParam:
      name: limit
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
      description: Número máximo de itens
    OffsetParam:
      name: offset
      in: query
      required: false
      schema:
        type: integer
        minimum: 0
      description: Número de itens para pular
  responses:
    AppError:
      description: Erro padronizado (AppError)
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
      required: [error]
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
      required: [status]
    RootResponse:
      type: object
      properties:
        name:
          type: string
        version:
          type: string
        environment:
          type: string
        docs:
          type: string
        openapi:
          type: string
        health:
          type: string
        ready:
          type: string
      required: [name, version, environment, docs, openapi, health, ready]
    CreateUserRequest:
      type: object
      required:
        - full_name
        - birth_date
        - cpf
        - phone
        - account_type
      properties:
        full_name:
          type: string
        birth_date:
          type: string
          format: date
        cpf:
          type: string
        phone:
          type: string
        account_type:
          type: string
          enum: [basic_care, professional]
          description: |-
            Nota (MVP): apenas `basic_care` está disponível no momento.
        professional:
          $ref: "#/components/schemas/ProfessionalRequestData"
          description: |-
            Nota (MVP): ainda não implementado. Se `account_type=professional`, a API vai rejeitar a criação.
    ProfessionalRequestData:
      type: object
      required:
        - kind
        - registration_number
        - registration_issuer
      properties:
        kind:
          type: string
        registration_number:
          type: string
        registration_issuer:
          type: string
        registration_state:
          type: string
          nullable: true
    UpdateUserRequest:
      type: object
      properties:
        full_name:
          type: string
          nullable: true
        birth_date:
          type: string
          format: date
          nullable: true
        cpf:
          type: string
          nullable: true
        phone:
          type: string
          nullable: true
    CreatePatientRequest:
      type: object
      required:
        - cpf
        - full_name
        - birth_date
        - gender
        - race
      properties:
        cpf:
          type: string
        full_name:
          type: string
        birth_date:
          type: string
          format: date
        gender:
          type: string
          enum: [MALE, FEMALE, OTHER, UNKNOWN]
        race:
          type: string
          enum: [WHITE, BLACK, ASIAN, MIXED, INDIGENOUS, UNKNOWN]
        phone:
          type: string
          nullable: true
        avatar_url:
          type: string
    PatientCreatedResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
      required: [id]
    User:
      type: object
      description: Representação simplificada do usuário.
      additionalProperties: true
    Patient:
      type: object
      description: Representação simplificada do paciente.
      additionalProperties: true
    PatientsList:
      type: array
      items:
        $ref: "#/components/schemas/Patient"
    LabsList:
      type: array
      items:
        type: object
        additionalProperties: true
    LabUploadResponse:
      type: object
      description: Retorno do processamento do laudo.
      additionalProperties: true
